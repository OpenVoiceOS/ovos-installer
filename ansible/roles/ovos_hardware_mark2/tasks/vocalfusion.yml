---
- name: Clone VocalFusionDriver Git repository
  ansible.builtin.git:
    repo: "{{ ovos_hardware_mark2_vocalfusion_repo_url }}"
    dest: "{{ ovos_hardware_mark2_vocalfusion_src_path }}"
    version: "{{ ovos_hardware_mark2_vocalfusion_branch }}"

- name: Copy DTBO files to boot overlays directory
  vars:
    _is_rpi5: >-
      {{ ovos_hardware_mark2_pi5_suffix
         if (ovos_hardware_mark2_pi5_model_match | default('')) in (ovos_installer_raspberrypi | default(''))
         else '' }}
    _dtbo_file: "{{ item }}{{ _is_rpi5 }}.dtbo"
  ansible.builtin.copy:
    src: "{{ ovos_hardware_mark2_vocalfusion_src_path }}/{{ _dtbo_file }}"
    dest: "{{ ovos_hardware_mark2_boot_overlays_dir }}/{{ _dtbo_file }}"
    owner: root
    group: root
    mode: "0755"
    remote_src: true
  loop: "{{ ovos_hardware_mark2_vocalfusion_dtbo_overlays }}"

- name: Manage sj201, buttons and PWM overlays
  ansible.builtin.lineinfile:
    path: "{{ ovos_hardware_mark2_boot_config_path }}"
    regexp: "^{{ item }}="
    line: >-
      {{ item }}{{ ovos_hardware_mark2_pi5_suffix
         if (ovos_hardware_mark2_pi5_model_match | default('')) in (ovos_installer_raspberrypi | default(''))
         else '' }}
  loop: "{{ ovos_hardware_mark2_vocalfusion_dtbo_overlays | map('regex_replace', '^', 'dtoverlay=') | list }}"

- name: Build vocalfusion-soundcard.ko kernel module
  ansible.builtin.shell:
    cmd: "{{ ovos_hardware_mark2_vocalfusion_make_cmd }}"
    executable: "{{ ovos_hardware_mark2_shell_executable }}"
    chdir: "{{ ovos_hardware_mark2_vocalfusion_driver_dir }}"
  changed_when: false

- name: Copy vocalfusion-soundcard.ko to /lib/modules/{{ ansible_facts.kernel }}
  ansible.builtin.copy:
    src: "{{ ovos_hardware_mark2_vocalfusion_driver_dir }}/{{ ovos_hardware_mark2_vocalfusion_module_name }}.ko"
    dest: "{{ ovos_hardware_mark2_vocalfusion_module_path }}"
    owner: root
    group: root
    mode: "0644"
  notify:
    - Run Depmod
    - Set Reboot

- name: Create modules-load config for vocalfusion
  ansible.builtin.copy:
    content: "{{ ovos_hardware_mark2_modules_load_content }}"
    dest: "{{ ovos_hardware_mark2_modules_load_path }}"
    owner: root
    group: root
    mode: "0644"

- name: Create sj201 Python virtualenv
  moreati.uv.pip:
    name: "{{ ovos_hardware_mark2_sj201_venv_packages }}"
    virtualenv: "{{ ovos_hardware_mark2_sj201_venv_path }}"
    virtualenv_command: "{{ ovos_hardware_mark2_sj201_venv_command }}"

- name: Download SJ201 firmware and scripts
  ansible.builtin.get_url:
    url: "{{ item.url }}"
    dest: "{{ ovos_hardware_mark2_working_dir }}/{{ item.dest }}"
    owner: root
    group: root
    mode: "0755"
  loop: "{{ ovos_hardware_mark2_sj201_downloads }}"

- name: Copy SJ201 systemd unit file
  ansible.builtin.template:
    src: sj201.service.j2
    dest: "{{ ovos_hardware_mark2_sj201_unit_path }}"
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: "{{ ovos_hardware_mark2_sj201_unit_mode }}"
  notify: Reload Systemd User

- name: Flush handlers vocalfusion
  ansible.builtin.meta: flush_handlers

- name: Enable SJ201 systemd unit
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.systemd_service:
    name: "{{ ovos_hardware_mark2_sj201_unit_name }}"
    enabled: true
    force: true
    scope: user

- name: Delete vocalfusion source once compiled
  ansible.builtin.file:
    path: "{{ ovos_hardware_mark2_vocalfusion_src_path }}"
    state: absent
