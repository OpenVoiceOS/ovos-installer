---
- name: Enable CRB repository
  ansible.builtin.command:
    cmd: dnf config-manager --enable crb
  changed_when: false
  when:
    - ansible_facts.os_family == "RedHat"
    - ansible_facts.distribution != "Fedora"

- name: Add EPEL repository
  ansible.builtin.dnf:
    name: epel-release
  when:
    - ansible_facts.os_family == "RedHat"
    - ansible_facts.distribution != "Fedora"

- name: Handle virtualenv package requirements (ovos/hivemind)
  ansible.builtin.apt:
    name:
      - build-essential
      - swig
      - libfann-dev
      - libasound2-dev
      - libpulse-dev
      - libportaudio2
      - mpg123
      - music123
      - sox
      - libsox-fmt-all
      - libespeak-ng1
      - espeak-ng
      - flac
      - mpv
      - libxslt1-dev
      - libopenblas-dev
      - pkg-config
      - libicu-dev
      - portaudio19-dev
      - libjpeg-dev
    install_recommends: false
    state: present
  when: ansible_facts.os_family in ['Debian', 'Zorin OS']

- name: Handle virtualenv package requirements (ovos/hivemind)
  ansible.builtin.dnf:
    name:
      - gcc-c++
      - swig
      - fann-devel
      - alsa-lib-devel
      - pulseaudio-libs-devel
      - portaudio
      - mpg123
      - sox
      - flac
      - mpv
      - openblas-serial
      - pkgconf-pkg-config
      - libicu-devel
      - portaudio-devel
      - espeak-ng
    state: present
  when: ansible_facts.os_family == "RedHat"

- name: Handle virtualenv package requirements (ovos/hivemind)
  community.general.zypper:
    name:
      - gcc-c++
      - swig
      - libfann-devel
      - alsa-lib-devel
      - libpulse-devel
      - libportaudio2
      - libespeak-ng1
      - espeak-ng
      - mpg123
      - sox
      - flac
      - mpv
      - libopenblas_serial-devel
      - portaudio-devel
    state: present
  when: ansible_facts.os_family == "Suse"

- name: Handle virtualenv package requirements (ovos/hivemind)
  community.general.pacman:
    name:
      - base-devel
      - swig
      - alsa-lib
      - portaudio
      - mpg123
      - sox
      - flac
      - mpv
      - libxslt
      - openblas
      - espeak-ng
    state: present
  when: ansible_facts.os_family == "Archlinux"

- name: Check Xcode Command Line Tools installation (macOS)
  ansible.builtin.command:
    cmd: xcode-select -p
  register: ovos_virtualenv_macos_clt
  changed_when: false
  failed_when: false
  when: ansible_facts.system == "Darwin"

- name: Assert Xcode Command Line Tools are installed (macOS)
  ansible.builtin.assert:
    that:
      - ovos_virtualenv_macos_clt.rc == 0
    fail_msg: >-
      Xcode Command Line Tools are required on macOS. Run 'xcode-select --install'
      and rerun the installer.
  when: ansible_facts.system == "Darwin"

- name: Handle virtualenv package requirements (ovos/hivemind)
  become: true
  become_user: "{{ ovos_installer_user }}"
  community.general.homebrew:
    name: "{{ ovos_virtualenv_macos_packages }}"
    state: present
    path: "{{ ovos_virtualenv_homebrew_path }}"
    update_homebrew: false
  environment:
    PATH: "{{ ovos_virtualenv_homebrew_path }}:{{ ansible_env.PATH | default('/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:/usr/sbin:/sbin') }}"
  when: ansible_facts.system == "Darwin"

- name: Ensure user local bin directory exists for build compatibility shims (macOS)
  ansible.builtin.file:
    path: "{{ ovos_installer_user_home }}/.local/bin"
    state: directory
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: "0755"
  when: ansible_facts.system == "Darwin"

- name: Resolve swig binary path for fann2 builds (macOS)
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.command:
    cmd: "which swig"
  register: ovos_virtualenv_macos_swig_bin
  changed_when: false
  environment:
    PATH: "{{ ovos_virtualenv_homebrew_path }}:{{ ansible_env.PATH | default('/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:/usr/sbin:/sbin') }}"
  when: ansible_facts.system == "Darwin"

- name: Ensure swig2.0 compatibility shim exists (macOS)
  ansible.builtin.file:
    src: "{{ ovos_virtualenv_macos_swig_bin.stdout | trim }}"
    dest: "{{ ovos_installer_user_home }}/.local/bin/swig2.0"
    state: link
    force: true
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
  when:
    - ansible_facts.system == "Darwin"
    - (ovos_virtualenv_macos_swig_bin.stdout | default('') | trim | length) > 0

- name: Check Homebrew fann lib directory for compatibility
  ansible.builtin.stat:
    path: "{{ ovos_virtualenv_macos_fann_source_lib_dir }}"
  register: ovos_virtualenv_macos_fann_source_dir
  when:
    - ansible_facts.system == "Darwin"
    - ovos_virtualenv_macos_fann_source_lib_dir != ovos_virtualenv_macos_fann_target_lib_dir

- name: Discover Homebrew fann dylibs on macOS
  ansible.builtin.find:
    paths: "{{ ovos_virtualenv_macos_fann_source_lib_dir }}"
    patterns: "libdoublefann*.dylib"
    file_type: file
  register: ovos_virtualenv_macos_fann_dylibs
  when:
    - ansible_facts.system == "Darwin"
    - ovos_virtualenv_macos_fann_source_lib_dir != ovos_virtualenv_macos_fann_target_lib_dir
    - ovos_virtualenv_macos_fann_source_dir.stat.exists | default(false)

- name: Ensure fallback lib directory exists for fann build compatibility
  ansible.builtin.file:
    path: "{{ ovos_virtualenv_macos_fann_target_lib_dir }}"
    state: directory
    mode: "0755"
  when:
    - ansible_facts.system == "Darwin"
    - ovos_virtualenv_macos_fann_source_lib_dir != ovos_virtualenv_macos_fann_target_lib_dir
    - ovos_virtualenv_macos_fann_dylibs.matched | default(0) | int > 0

- name: Create fann compatibility symlinks for legacy build scripts
  ansible.builtin.file:
    src: "{{ item.path }}"
    dest: "{{ ovos_virtualenv_macos_fann_target_lib_dir }}/{{ item.path | basename }}"
    state: link
    force: true
  loop: "{{ ovos_virtualenv_macos_fann_dylibs.files | default([]) }}"
  loop_control:
    label: "{{ item.path | basename }}"
  when:
    - ansible_facts.system == "Darwin"
    - ovos_virtualenv_macos_fann_source_lib_dir != ovos_virtualenv_macos_fann_target_lib_dir
    - ovos_virtualenv_macos_fann_dylibs.matched | default(0) | int > 0

- name: Handle fann package from AUR (Arch based only)
  become_user: "{{ ovos_installer_user }}"
  kewlfft.aur.aur:
    name: fann
    use: makepkg
  when: ansible_facts.os_family == "Archlinux"
  tags:
    - skip_ansible_lint
