- name: Copy Python requirements.txt files
  ansible.builtin.template:
    src: "{{ item.file }}.j2"
    dest: "{{ item.dest }}"
    owner: root
    group: "{{ 'wheel' if ansible_facts.system == 'Darwin' else 'root' }}"
    mode: "0644"
  loop: "{{ ovos_virtualenv_requirements_files }}"
  loop_control:
    label: "{{ item.file }}"
  when: item.state | bool

- name: Ensure dedicated uv cache directory exists
  ansible.builtin.file:
    path: "{{ ovos_virtualenv_uv_cache_dir }}"
    state: directory
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: "0755"
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Ensure uv has requested Python available
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.command:
    cmd: "uv python install {{ ovos_virtualenv_venv_python }}"
  changed_when: false
  environment:
    HOME: "{{ ovos_installer_user_home }}"
    PATH: "{{ ovos_virtualenv_uv_exec_path }}"
    UV_CACHE_DIR: "{{ ovos_virtualenv_uv_cache_dir }}"
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Check installer uv binary
  ansible.builtin.stat:
    path: "{{ ovos_virtualenv_installer_venv_path }}/bin/uv"
  register: ovos_virtualenv_uv_bin
  changed_when: false
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Ensure user local bin exists
  ansible.builtin.file:
    path: "{{ ovos_installer_user_home }}/.local/bin"
    state: directory
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: '0755'
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Install uv for user from installer venv
  ansible.builtin.copy:
    src: "{{ ovos_virtualenv_installer_venv_path }}/bin/uv"
    dest: "{{ ovos_installer_user_home }}/.local/bin/uv"
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: '0755'
    remote_src: true
  when:
    - not (ovos_installer_cleaning | default(false) | bool)
    - ovos_virtualenv_uv_bin.stat.exists | default(false)

- name: Warn if installer uv binary missing
  ansible.builtin.debug:
    msg: "uv binary not found in installer venv; skipping user install."
  when:
    - not (ovos_installer_cleaning | default(false) | bool)
    - not (ovos_virtualenv_uv_bin.stat.exists | default(false))

- name: Ensure ovos Python venv exists with requested Python
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.command:
    cmd: >-
      uv venv
      --python {{ ovos_virtualenv_venv_python }}
      --python-preference managed
      {{ ovos_virtualenv_path }}
  args:
    creates: "{{ ovos_virtualenv_path }}/bin/activate"
  environment:
    HOME: "{{ ovos_installer_user_home }}"
    PATH: "{{ ovos_virtualenv_uv_exec_path }}"
    UV_CACHE_DIR: "{{ ovos_virtualenv_uv_cache_dir }}"
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Read OVOS venv pyvenv.cfg
  ansible.builtin.slurp:
    src: "{{ ovos_virtualenv_path }}/pyvenv.cfg"
  register: ovos_virtualenv_pyvenv_cfg
  failed_when: false
  changed_when: false
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Parse OVOS venv interpreter hints from pyvenv.cfg
  ansible.builtin.set_fact:
    ovos_virtualenv_pyvenv_executable: >-
      {{
        (
          (ovos_virtualenv_pyvenv_cfg.content | default('') | b64decode)
          | regex_findall('^executable\\s*=\\s*(.+)$', multiline=True)
          | first | default('')
        ) | trim
      }}
    ovos_virtualenv_pyvenv_home: >-
      {{
        (
          (ovos_virtualenv_pyvenv_cfg.content | default('') | b64decode)
          | regex_findall('^home\\s*=\\s*(.+)$', multiline=True)
          | first | default('')
        ) | trim
      }}
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Build OVOS venv external base interpreter candidates
  ansible.builtin.set_fact:
    ovos_virtualenv_base_python_candidates: >-
      {{
        (
          ([ovos_virtualenv_pyvenv_executable]
           if (ovos_virtualenv_pyvenv_executable | default('') | length) > 0
           else [])
          +
          ([
            ovos_virtualenv_pyvenv_home ~ '/python' ~ ovos_virtualenv_venv_python,
            ovos_virtualenv_pyvenv_home ~ '/python3',
            ovos_virtualenv_pyvenv_home ~ '/python'
          ] if (ovos_virtualenv_pyvenv_home | default('') | length) > 0 else [])
        )
        | reject('equalto', '')
        | unique
        | list
      }}
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Resolve OVOS base interpreter from uv managed Python when pyvenv hints are missing
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.command:
    cmd: "uv python find {{ ovos_virtualenv_venv_python }}"
  register: ovos_virtualenv_uv_python_find
  changed_when: false
  failed_when: false
  environment:
    HOME: "{{ ovos_installer_user_home }}"
    PATH: "{{ ovos_virtualenv_uv_exec_path }}"
    UV_CACHE_DIR: "{{ ovos_virtualenv_uv_cache_dir }}"
  when:
    - not (ovos_installer_cleaning | default(false) | bool)
    - (ovos_virtualenv_base_python_candidates | default([]) | length) == 0

- name: Add uv managed base interpreter candidate
  ansible.builtin.set_fact:
    ovos_virtualenv_base_python_candidates: >-
      {{
        (ovos_virtualenv_base_python_candidates | default([]))
        + [ovos_virtualenv_uv_python_find.stdout | trim]
      }}
  when:
    - not (ovos_installer_cleaning | default(false) | bool)
    - (ovos_virtualenv_base_python_candidates | default([]) | length) == 0
    - (ovos_virtualenv_uv_python_find.stdout | default('') | trim | length) > 0

- name: Check OVOS venv external base interpreter candidates
  ansible.builtin.stat:
    path: "{{ item }}"
    follow: true
  register: ovos_virtualenv_base_python_candidate_stats
  changed_when: false
  failed_when: false
  loop: "{{ ovos_virtualenv_base_python_candidates }}"
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Initialize OVOS venv base interpreter
  ansible.builtin.set_fact:
    ovos_virtualenv_base_python_executable: ""
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Select OVOS venv base interpreter candidate
  ansible.builtin.set_fact:
    ovos_virtualenv_base_python_executable: "{{ item.item }}"
  loop: "{{ ovos_virtualenv_base_python_candidate_stats.results | default([]) }}"
  when:
    - not (ovos_installer_cleaning | default(false) | bool)
    - (ovos_virtualenv_base_python_executable | length) == 0
    - item.stat.exists | default(false)
    - item.stat.isreg | default(false)
    - item.stat.executable | default(false)

- name: Check OVOS venv base interpreter target
  ansible.builtin.stat:
    path: "{{ ovos_virtualenv_base_python_executable }}"
    follow: true
  register: ovos_virtualenv_base_python_target_stat
  changed_when: false
  failed_when: false
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Assert OVOS venv base interpreter is available
  ansible.builtin.assert:
    that:
      - (ovos_virtualenv_base_python_candidates | default([]) | length) > 0
      - (ovos_virtualenv_base_python_executable | default('') | trim | length) > 0
      - ovos_virtualenv_base_python_target_stat.stat.exists | default(false)
      - ovos_virtualenv_base_python_target_stat.stat.isreg | default(false)
      - ovos_virtualenv_base_python_target_stat.stat.executable | default(false)
    fail_msg: >-
      Unable to locate a valid base Python interpreter for {{ ovos_virtualenv_path }}.
      Check {{ ovos_virtualenv_path }}/pyvenv.cfg and recreate the venv if needed.
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Ensure OVOS venv versioned python points to base interpreter
  ansible.builtin.file:
    src: "{{ ovos_virtualenv_base_python_executable | trim }}"
    dest: "{{ ovos_virtualenv_path }}/bin/python{{ ovos_virtualenv_venv_python }}"
    state: link
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    force: true
    follow: false
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Ensure OVOS venv python3 symlink points to versioned executable
  ansible.builtin.file:
    src: "{{ ovos_virtualenv_path }}/bin/python{{ ovos_virtualenv_venv_python }}"
    dest: "{{ ovos_virtualenv_path }}/bin/python3"
    state: link
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    force: true
    follow: false
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Ensure OVOS venv python command points to versioned executable
  ansible.builtin.file:
    src: "{{ ovos_virtualenv_path }}/bin/python{{ ovos_virtualenv_venv_python }}"
    dest: "{{ ovos_virtualenv_path }}/bin/python"
    state: link
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    force: true
    follow: false
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Ensure OVOS virtualenv ownership is aligned before package installs
  ansible.builtin.file:
    path: "{{ ovos_virtualenv_path }}"
    state: directory
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    recurse: true
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Ensure pip is available in OVOS venv
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.command:
    cmd: "{{ ovos_virtualenv_path }}/bin/python -m ensurepip --upgrade"
  args:
    creates: "{{ ovos_virtualenv_path }}/bin/pip"
  environment:
    HOME: "{{ ovos_installer_user_home }}"
  register: ovos_virtualenv_pip_bootstrap
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Upgrade pip tooling in OVOS venv
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.command:
    cmd: >-
      {{ ovos_virtualenv_path }}/bin/python -m pip install -U
      pip wheel
      "{{ ovos_virtualenv_setuptools_package }}"
  environment:
    HOME: "{{ ovos_installer_user_home }}"
  changed_when: false
  when:
    - not (ovos_installer_cleaning | default(false) | bool)
    - ovos_virtualenv_pip_bootstrap is defined
    - ovos_virtualenv_pip_bootstrap is changed

- name: Install tflite_runtime bootstrap package (non-macOS AVX/SIMD hosts)
  become: true
  become_user: "{{ ovos_installer_user }}"
  moreati.uv.pip:
    name: tflite_runtime
    virtualenv: "{{ ovos_virtualenv_path }}"
    extra_args: "--trusted-host whl.smartgic.io -f 'https://whl.smartgic.io'"
  environment:
    HOME: "{{ ovos_installer_user_home }}"
    PATH: "{{ ovos_virtualenv_uv_exec_path }}"
    UV_CACHE_DIR: "{{ ovos_virtualenv_uv_cache_dir }}"
  when:
    - not (ovos_installer_cleaning | default(false) | bool)
    - ovos_installer_cpu_is_capable | bool
    - ansible_facts.system != 'Darwin'

- name: Install wheel bootstrap package (macOS or non-AVX/SIMD hosts)
  become: true
  become_user: "{{ ovos_installer_user }}"
  moreati.uv.pip:
    name: wheel
    virtualenv: "{{ ovos_virtualenv_path }}"
  environment:
    HOME: "{{ ovos_installer_user_home }}"
    PATH: "{{ ovos_virtualenv_uv_exec_path }}"
    UV_CACHE_DIR: "{{ ovos_virtualenv_uv_cache_dir }}"
  when:
    - not (ovos_installer_cleaning | default(false) | bool)
    - ansible_facts.system == 'Darwin' or not (ovos_installer_cpu_is_capable | bool)

- name: Install ggwave Python library
  become: true
  become_user: "{{ ovos_installer_user }}"
  moreati.uv.pip:
    name: ggwave
    virtualenv: "{{ ovos_virtualenv_path }}"
    extra_args: "--trusted-host whl.smartgic.io -f 'https://whl.smartgic.io'"
  environment:
    HOME: "{{ ovos_installer_user_home }}"
    PATH: "{{ ovos_virtualenv_uv_exec_path }}"
    UV_CACHE_DIR: "{{ ovos_virtualenv_uv_cache_dir }}"
  when:
    - not (ovos_installer_cleaning | default(false) | bool)
    - ovos_installer_enable_ggwave | bool

- name: Install Open Voice OS in Python venv
  become: true
  become_user: "{{ ovos_installer_user }}"
  vars:
    _ovos_release: "https://raw.githubusercontent.com/OpenVoiceOS/ovos-releases/refs/heads/main/constraints-{{ ovos_installer_channel }}.txt"
    _pip_constraints: "--constraint {{ _ovos_release }}"
    _uv_extra_args: "{{ _pip_constraints }}{{ ' --prerelease=allow' if ovos_virtualenv_uv_allow_prerelease | bool else '' }}"
    _ovos_virtualenv_uv_env:
      HOME: "{{ ovos_installer_user_home }}"
      PATH: "{{ ovos_virtualenv_uv_exec_path }}"
      UV_CACHE_DIR: "{{ ovos_virtualenv_uv_cache_dir }}"
    _ovos_virtualenv_install_env: >-
      {{
        _ovos_virtualenv_uv_env
        | combine(
            {
              'LDFLAGS': ovos_virtualenv_macos_fann_linker_flags,
              'LIBRARY_PATH': ovos_virtualenv_macos_fann_library_path,
              'PKG_CONFIG_PATH': ovos_virtualenv_macos_fann_pkg_config_path
            } if ansible_facts.system == 'Darwin' else {}
          )
      }}
  moreati.uv.pip:
    requirements: "{{ item.dest }}"
    virtualenv: "{{ ovos_virtualenv_path }}"
    extra_args: "{{ _uv_extra_args }}"
    state: latest
  environment: "{{ _ovos_virtualenv_install_env }}"
  register: ovos_virtualenv_install
  until: ovos_virtualenv_install is success
  retries: 5
  delay: 5
  loop: "{{ ovos_virtualenv_requirements_files }}"
  loop_control:
    label: "{{ item.file }}"
  when: item.state | bool

- name: Ensure numpy Python library is installed
  become: true
  become_user: "{{ ovos_installer_user }}"
  moreati.uv.pip:
    name: "{{ ovos_virtualenv_numpy_package }}"
    virtualenv: "{{ ovos_virtualenv_path }}"
    state: present
  environment:
    HOME: "{{ ovos_installer_user_home }}"
    PATH: "{{ ovos_virtualenv_uv_exec_path }}"
    UV_CACHE_DIR: "{{ ovos_virtualenv_uv_cache_dir }}"
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Ensure setuptools Python library is compatible with OVOS runtime
  become: true
  become_user: "{{ ovos_installer_user }}"
  moreati.uv.pip:
    name: "{{ ovos_virtualenv_setuptools_package }}"
    virtualenv: "{{ ovos_virtualenv_path }}"
    state: present
  environment:
    HOME: "{{ ovos_installer_user_home }}"
    PATH: "{{ ovos_virtualenv_uv_exec_path }}"
    UV_CACHE_DIR: "{{ ovos_virtualenv_uv_cache_dir }}"
  when: not (ovos_installer_cleaning | default(false) | bool)

- name: Check ovos virtualenv activate script exists
  ansible.builtin.stat:
    path: "{{ ovos_virtualenv_path }}/bin/activate"
  register: ovos_virtualenv_activate_script

- name: Add OVOS constraints to venv activation
  vars:
    _ovos_release: "https://raw.githubusercontent.com/OpenVoiceOS/ovos-releases/refs/heads/main/constraints-{{ ovos_installer_channel }}.txt"
  ansible.builtin.lineinfile:
    path: "{{ ovos_virtualenv_path }}/bin/activate"
    line: "{{ item.line }}"
    regexp: "{{ item.regexp }}"
    insertafter: "{{ item.insertafter }}"
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    state: present
  loop:
    - line: "export PIP_CONSTRAINT=\"{{ _ovos_release }}\""
      regexp: "^export PIP_CONSTRAINT="
      insertafter: "^VIRTUAL_ENV="
    - line: "export UV_CONSTRAINT=\"{{ _ovos_release }}\""
      regexp: "^export UV_CONSTRAINT="
      insertafter: "^export PIP_CONSTRAINT="
  loop_control:
    label: "{{ item.regexp }}"
  when: ovos_virtualenv_activate_script.stat.exists | default(false)

- name: Add VIRTUAL_ENV variable to shell init file and update user PATH
  vars:
    _path: "{{ ovos_virtualenv_path }}/bin"
  ansible.builtin.lineinfile:
    path: "{{ ovos_virtualenv_shell_init_file }}"
    line: "{{ item.line }}"
    regexp: "{{ item.regexp }}"
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: "0644"
    create: true
    state: present
  loop:
    - line: "VIRTUAL_ENV={{ _path }}"
      regexp: "^VIRTUAL_ENV"
    - line: "PATH=$PATH:{{ _path }}"
      regexp: "^PATH"
  loop_control:
    label: "{{ item.regexp }}"
  when: (ovos_installer_i2c_devices | default([])) | length < 1
  tags:
    - always

- name: Ensure OVOS virtualenv auto-activates for interactive shells
  ansible.builtin.blockinfile:
    path: "{{ ovos_virtualenv_shell_init_file }}"
    marker: "# {mark} OVOS VENV"
    block: |
      if [[ $- == *i* ]] && [ -f "{{ ovos_virtualenv_path }}/bin/activate" ]; then
        source "{{ ovos_virtualenv_path }}/bin/activate"
      fi
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: "0644"
    create: true
    state: present
  tags:
    - always

- name: Generate _identity.json
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.command:
    argv:
      - hivemind-client
      - set-identity
      - --key
      - "{{ ovos_installer_satellite_key }}"
      - --password
      - "{{ ovos_installer_satellite_password }}"
      - --host
      - "{{ ovos_installer_listener_host }}"
      - --port
      - "{{ ovos_installer_listener_port | default(5678) }}"
      - --siteid
      - "{{ ovos_installer_site_id | default('voice-sat-1') }}"
  environment:
    PATH: "{{ ovos_virtualenv_path }}/bin"
    VIRTUAL_ENV: "{{ ovos_virtualenv_path }}"
  changed_when: false
  when: ovos_installer_profile == "satellite"

- name: Check for existing mycroft.conf
  ansible.builtin.stat:
    path: >-
      {{ ovos_installer_user_home }}/{{ '.config/mycroft' if ovos_installer_method == 'virtualenv' else 'ovos/config' }}/mycroft.conf
  register: ovos_virtualenv_mycroft_conf
  changed_when: false

- name: Run ovos-config for auto-configuration of STT and TTS based on language
  vars:
    _ovos_config_tts_gender: "{{ '--female' if ovos_installer_locale in ['eu-ES', 'gl-ES'] else '--male' }}"
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.command:
    argv:
      - ovos-config
      - autoconfigure
      - --lang
      - "{{ ovos_installer_locale }}"
      - "{{ _ovos_config_tts_gender }}"
  environment:
    PATH: "{{ ovos_virtualenv_path }}/bin"
    VIRTUAL_ENV: "{{ ovos_virtualenv_path }}"
  changed_when: false
  when:
    - ovos_installer_profile != "server"
    - ovos_virtualenv_run_ovos_config | bool
    - not (ovos_virtualenv_mycroft_conf.stat.exists | default(false))

- name: Ensure Piper TTS data directory exists
  ansible.builtin.file:
    path: "{{ ovos_virtualenv_piper_data_dir }}"
    state: directory
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: "0755"
  when:
    - ovos_installer_profile != "server"
    - ovos_virtualenv_set_fallback_tts | bool

- name: Read configured fallback TTS module
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.command:
    argv:
      - ovos-config
      - get
      - -k
      - /tts/fallback_module
  environment:
    PATH: "{{ ovos_virtualenv_path }}/bin"
    VIRTUAL_ENV: "{{ ovos_virtualenv_path }}"
  register: ovos_virtualenv_tts_fallback_module_value
  changed_when: false
  failed_when: false
  when:
    - ovos_installer_profile != "server"
    - ovos_virtualenv_set_fallback_tts | bool

- name: Configure default fallback TTS module
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.command:
    argv:
      - ovos-config
      - set
      - -k
      - /tts/fallback_module
      - -v
      - "{{ ovos_virtualenv_fallback_tts_module }}"
  environment:
    PATH: "{{ ovos_virtualenv_path }}/bin"
    VIRTUAL_ENV: "{{ ovos_virtualenv_path }}"
  changed_when: false
  when:
    - ovos_installer_profile != "server"
    - ovos_virtualenv_set_fallback_tts | bool
    - ovos_virtualenv_tts_fallback_module_value.rc != 0 or (ovos_virtualenv_tts_fallback_module_value.stdout is search('Value:\\s*,\\s*found in /tts/fallback_module'))
