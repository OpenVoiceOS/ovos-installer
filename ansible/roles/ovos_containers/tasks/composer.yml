---
- name: Retrieve groups information
  ansible.builtin.getent:
    database: group
  tags:
    - always

- name: Generate .env file for docker-compose
  ansible.builtin.template:
    src: docker/env.j2
    dest: "{{ ovos_containers_composition_directory }}/.env"
    owner: root
    group: root
    mode: "0644"
  tags:
    - always

- name: Define composition
  ansible.builtin.set_fact:
    ovos_containers_composition_files: "{{ ovos_containers_composition_files | default([]) + [item.file] }}"
  loop: "{{ ovos_containers_compose_definitions }}"
  when:
    - item.state | bool
    # Manage skills-extra separately (so Home Assistant can be enabled independently).
    - item.file != ovos_containers_compose_file_skills_extra

- name: Deploy docker-compose stack
  become: true
  become_user: "{{ ovos_installer_user }}"
  community.docker.docker_compose_v2:
    project_src: "{{ ovos_containers_composition_directory }}"
    project_name: "{{ ovos_containers_compose_project_name }}"
    files: "{{ ovos_containers_composition_files }}"
    pull: "{{ ovos_containers_docker_pull_policy }}"
    remove_orphans: "{{ ovos_containers_docker_compose_remove_orphans }}"
    remove_images: "{{ ovos_containers_docker_compose_remove_images }}"
    remove_volumes: "{{ ovos_containers_docker_compose_remove_volumes }}"
  register: ovos_containers_docker_compose
  until: not ovos_containers_docker_compose.failed | bool
  retries: 5
  delay: 3
  environment:
    DOCKER_TIMEOUT: "{{ ovos_containers_docker_timeout }}"

- name: Generate _identity.json
  become: true
  become_user: "{{ ovos_installer_user }}"
  community.docker.docker_container_exec:
    container: "{{ ovos_containers_container_hivemind_cli }}"
    command: >
      hivemind-client set-identity
      --key {{ ovos_installer_satellite_key }}
      --password {{ ovos_installer_satellite_password }}
      --host {{ ovos_installer_listener_host }}
      --port {{ ovos_installer_listener_port | default(ovos_containers_listener_port_default) }}
      --siteid {{ ovos_installer_site_id | default(ovos_containers_site_id_default) }}
  when: ovos_installer_profile == "satellite"

- name: Run ovos-config for auto-configuration of STT and TTS based on language
  become: true
  become_user: "{{ ovos_installer_user }}"
  community.docker.docker_container_exec:
    container: "{{ ovos_containers_container_ovos_cli }}"
    command: ovos-config autoconfigure --lang {{ ovos_installer_locale }} --male --online
  when: ovos_installer_profile != "server"

- name: Compute optional skills flags
  vars:
    _ovos_homeassistant_url: >-
      {{
        ovos_installer_homeassistant_url
        | default(ovos_installer_homeassistant_host | default(''), true)
      }}
    _skills_supported: >-
      {{
        (ovos_installer_profile not in ['satellite', 'server'])
        and ((ansible_facts.memtotal_mb | default(0) | int) >= (ovos_containers_min_mem_mb_for_skills | int))
      }}
  ansible.builtin.set_fact:
    ovos_containers_homeassistant_url: "{{ _ovos_homeassistant_url }}"
    ovos_containers_homeassistant_enabled: >-
      {{
        _skills_supported
        and (ovos_installer_feature_homeassistant | default(false) | bool)
        and (_ovos_homeassistant_url | length > 0)
        and ((ovos_installer_homeassistant_api_key | default('')) | length > 0)
      }}
    ovos_containers_extra_skills_enabled: >-
      {{
        _skills_supported
        and (ovos_installer_feature_extra_skills | default(false) | bool)
      }}

- name: Read services from skills-extra docker-compose file (when needed)
  ansible.builtin.slurp:
    src: "{{ ovos_containers_composition_directory }}/{{ ovos_containers_compose_file_skills_extra }}"
  register: ovos_containers_skills_extra_compose_raw
  changed_when: false
  when:
    - (ovos_containers_homeassistant_enabled | default(false) | bool) or (ovos_containers_extra_skills_enabled | default(false) | bool)

- name: Parse skills-extra docker-compose services
  ansible.builtin.set_fact:
    ovos_containers_skills_extra_services: >-
      {{
        (
          (ovos_containers_skills_extra_compose_raw.content | b64decode | from_yaml).services
          | default({})
          | dict2items
          | map(attribute='key')
          | list
        )
      }}
  when:
    - ovos_containers_skills_extra_compose_raw is defined
    - ovos_containers_skills_extra_compose_raw.content is defined

- name: Assert Home Assistant service exists in skills-extra docker-compose file (when enabled)
  ansible.builtin.assert:
    that:
      - ovos_containers_service_skill_homeassistant in (ovos_containers_skills_extra_services | default([]))
    fail_msg: >-
      Home Assistant integration is enabled, but the service
      "{{ ovos_containers_service_skill_homeassistant }}" was not found in
      "{{ ovos_containers_composition_directory }}/{{ ovos_containers_compose_file_skills_extra }}".
      Upstream docker-compose definitions may have changed.
    success_msg: "Home Assistant service definition detected."
  when: ovos_containers_homeassistant_enabled | default(false) | bool

- name: Deploy extra skills containers (without Home Assistant unless configured)
  vars:
    _services_all: "{{ ovos_containers_skills_extra_services | default([]) }}"
    _services_selected: >-
      {{
        _services_all
        if (ovos_containers_homeassistant_enabled | default(false) | bool)
        else (_services_all | reject('equalto', ovos_containers_service_skill_homeassistant) | list)
      }}
  become: true
  become_user: "{{ ovos_installer_user }}"
  community.docker.docker_compose_v2:
    project_src: "{{ ovos_containers_composition_directory }}"
    project_name: "{{ ovos_containers_compose_project_name }}"
    files: "{{ ovos_containers_composition_files + [ovos_containers_compose_file_skills_extra] }}"
    pull: "{{ ovos_containers_docker_pull_policy }}"
    remove_orphans: "{{ ovos_containers_docker_compose_remove_orphans }}"
    remove_images: "{{ ovos_containers_docker_compose_remove_images }}"
    remove_volumes: "{{ ovos_containers_docker_compose_remove_volumes }}"
    services: "{{ _services_selected }}"
  register: ovos_containers_docker_compose_extra_skills
  until: not ovos_containers_docker_compose_extra_skills.failed | bool
  retries: 5
  delay: 3
  environment:
    DOCKER_TIMEOUT: "{{ ovos_containers_docker_timeout }}"
  when:
    - ovos_containers_extra_skills_enabled | default(false) | bool
    - _services_selected | length > 0

- name: Deploy Home Assistant skill container (when enabled without extra skills)
  become: true
  become_user: "{{ ovos_installer_user }}"
  community.docker.docker_compose_v2:
    project_src: "{{ ovos_containers_composition_directory }}"
    project_name: "{{ ovos_containers_compose_project_name }}"
    files: "{{ ovos_containers_composition_files + [ovos_containers_compose_file_skills_extra] }}"
    pull: "{{ ovos_containers_docker_pull_policy }}"
    remove_orphans: "{{ ovos_containers_docker_compose_remove_orphans }}"
    remove_images: "{{ ovos_containers_docker_compose_remove_images }}"
    remove_volumes: "{{ ovos_containers_docker_compose_remove_volumes }}"
    services:
      - "{{ ovos_containers_service_skill_homeassistant }}"
  register: ovos_containers_docker_compose_homeassistant
  until: not ovos_containers_docker_compose_homeassistant.failed | bool
  retries: 5
  delay: 3
  environment:
    DOCKER_TIMEOUT: "{{ ovos_containers_docker_timeout }}"
  when:
    - ovos_containers_homeassistant_enabled | default(false) | bool
    - not (ovos_containers_extra_skills_enabled | default(false) | bool)

- name: Remove Home Assistant skill container when not configured (extra skills selected)
  # docker compose doesn't remove services that are still defined in the compose
  # file but excluded from the "services:" list, so explicitly remove the
  # container to prevent it from lingering across re-runs.
  become: true
  community.docker.docker_container:
    name: "{{ ovos_containers_container_skill_homeassistant }}"
    state: absent
    force_kill: true
  when:
    - ovos_containers_extra_skills_enabled | default(false) | bool
    - not (ovos_containers_homeassistant_enabled | default(false) | bool)

- name: Delete composer directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ ovos_containers_repo_directories }}"
  tags:
    - always
