---
- name: Assert uninstall mode
  ansible.builtin.assert:
    that:
      - ovos_installer_cleaning | default(false) | bool
    fail_msg: "Uninstall tasks require ovos_installer_cleaning=true."
  tags:
    - uninstall

- name: Check for Docker socket
  ansible.builtin.stat:
    path: "{{ ovos_containers_docker_socket_path | default('/var/run/docker.sock') }}"
  register: ovos_containers_docker_socket_stat
  changed_when: false

- name: Check for docker-compose project directory
  ansible.builtin.stat:
    path: "{{ ovos_containers_composition_directory }}"
  register: ovos_containers_compose_project_stat
  changed_when: false

- name: Remove docker-compose stack(s)
  become: true
  community.docker.docker_compose_v2:
    project_src: "{{ ovos_containers_composition_directory }}"
    project_name: "{{ item.name }}"
    files: "{{ item.file }}"
    remove_orphans: "{{ ovos_containers_docker_compose_remove_orphans }}"
    remove_images: "{{ ovos_containers_docker_compose_remove_images }}"
    remove_volumes: "{{ ovos_containers_docker_compose_remove_volumes }}"
    timeout: "{{ ovos_containers_compose_timeout }}"
    state: absent
  loop: "{{ ovos_containers_uninstall_compose_mapping }}"
  environment:
    DOCKER_TIMEOUT: "{{ ovos_containers_docker_timeout }}"
  register: ovos_containers_composer_deletion
  when:
    - ovos_containers_docker_socket_stat.stat.exists | default(false) | bool
    - ovos_containers_compose_project_stat.stat.isdir | default(false) | bool

- name: List all containers
  become: true
  community.docker.docker_host_info:
    containers: true
    containers_all: true
  register: ovos_containers_host_info
  failed_when: ovos_containers_host_info is failed
  when: ovos_containers_docker_socket_stat.stat.exists | default(false) | bool

- name: Select containers to remove
  vars:
    _ovos_containers_uninstall_target_ids_raw: >-
      {% set prefixes = ovos_containers_uninstall_name_prefixes | default([]) %}
      {% set projects = ovos_containers_uninstall_project_names | default([]) %}
      {% set prefix_re = '' %}
      {% if prefixes | length > 0 %}
      {% set prefix_re = '^/?(' ~ (prefixes | map('regex_escape') | join('|')) ~ ')' %}
      {% endif %}
      {% set ns = namespace(ids=[]) %}
      {% for c in (ovos_containers_host_info.containers | default([])) %}
      {% set names = c.Names | default([]) %}
      {% set labels = c.Labels | default({}) %}
      {% set project = labels.get('com.docker.compose.project', '') %}
      {% set match_project = (projects | length > 0 and project | length > 0 and project in projects) %}
      {% set match_prefix = (prefix_re | length > 0 and (names | select('match', prefix_re) | list | length > 0)) %}
      {% if match_project or match_prefix %}
      {% set _ = ns.ids.append(c.Id) %}
      {% endif %}
      {% endfor %}
      {{ ns.ids | unique | list }}
  ansible.builtin.set_fact:
    ovos_containers_uninstall_target_ids: "{{ _ovos_containers_uninstall_target_ids_raw | from_yaml }}"
  when: ovos_containers_host_info is defined

- name: Remove containers
  become: true
  community.docker.docker_container:
    name: "{{ item }}"
    state: absent
    force_kill: true
    keep_volumes: "{{ not (ovos_containers_docker_compose_remove_volumes | bool) }}"
  loop: "{{ ovos_containers_uninstall_target_ids | default([]) }}"
  when: ovos_containers_uninstall_target_ids | default([]) | length > 0

- name: Check for cmdline.txt (cgroup cleanup)
  ansible.builtin.stat:
    path: "{{ ovos_containers_cmdline_path }}"
  register: ovos_containers_cmdline_stat
  changed_when: false

- name: Read cmdline.txt (cgroup cleanup)
  ansible.builtin.slurp:
    src: "{{ ovos_containers_cmdline_path }}"
  register: ovos_containers_cmdline_raw
  changed_when: false
  when:
    - ovos_containers_cmdline_stat.stat.exists | default(false) | bool

- name: Compute cmdline without memory cgroup parameters
  vars:
    _cmdline_text: "{{ ovos_containers_cmdline_raw.content | b64decode | trim }}"
    _tokens: "{{ _cmdline_text | regex_findall('\\S+') }}"
    _filtered_tokens: "{{ _tokens | reject('in', ovos_containers_cgroup_memory_params) | list }}"
  ansible.builtin.set_fact:
    ovos_containers_cmdline_original: "{{ _tokens | join(' ') }}"
    ovos_containers_cmdline_cleaned: "{{ _filtered_tokens | join(' ') }}"
  changed_when: false
  when:
    - ovos_containers_cmdline_stat.stat.exists | default(false) | bool

- name: Assert cmdline will not be emptied by cgroup cleanup
  ansible.builtin.assert:
    that:
      - ovos_containers_cmdline_cleaned | length > 0
    fail_msg: >-
      Refusing to write an empty cmdline.txt after removing memory cgroup parameters.
  when:
    - ovos_containers_cmdline_original is defined
    - ovos_containers_cmdline_cleaned is defined
    - ovos_containers_cmdline_original != ovos_containers_cmdline_cleaned

- name: Remove memory cgroup parameters (cmdline.txt)
  ansible.builtin.copy:
    dest: "{{ ovos_containers_cmdline_path }}"
    content: "{{ ovos_containers_cmdline_cleaned }}\n"
    owner: root
    group: root
    mode: "{{ ovos_containers_cmdline_stat.stat.mode | default('0644') }}"
  when:
    - ovos_containers_cmdline_original is defined
    - ovos_containers_cmdline_cleaned is defined
    - ovos_containers_cmdline_original != ovos_containers_cmdline_cleaned
  notify: Set Reboot

- name: Remove directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ ovos_containers_remove_directories }}"

- name: Delete composer directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ ovos_containers_repo_directories }}"
