---
- name: Assert uninstall mode
  ansible.builtin.assert:
    that:
      - ovos_installer_cleaning | default(false) | bool
    fail_msg: "Uninstall tasks require ovos_installer_cleaning=true."
  tags:
    - uninstall

- name: Remove docker-compose stack(s)
  become: true
  community.docker.docker_compose_v2:
    project_src: "{{ ovos_containers_composition_directory }}"
    project_name: "{{ item.name }}"
    files: "{{ item.file }}"
    remove_orphans: "{{ ovos_containers_docker_compose_remove_orphans }}"
    remove_images: "{{ ovos_containers_docker_compose_remove_images }}"
    remove_volumes: "{{ ovos_containers_docker_compose_remove_volumes }}"
    timeout: "{{ ovos_containers_compose_timeout }}"
    state: absent
  loop: "{{ ovos_containers_uninstall_compose_mapping }}"
  environment:
    DOCKER_TIMEOUT: "{{ ovos_containers_docker_timeout }}"
  register: ovos_containers_composer_deletion
  failed_when: ovos_containers_composer_deletion is not defined

- name: List compose containers by project label
  become: true
  community.docker.docker_container_info:
    filters:
      label: "com.docker.compose.project={{ item }}"
  loop: "{{ ovos_containers_uninstall_project_names }}"
  register: ovos_containers_uninstall_containers
  failed_when: false

- name: Flatten compose container list
  ansible.builtin.set_fact:
    ovos_containers_uninstall_container_ids: >-
      {{ ovos_containers_uninstall_containers.results
         | selectattr('containers', 'defined')
         | map(attribute='containers')
         | sum(start=[]) }}
  when: ovos_containers_uninstall_containers is defined

- name: Remove compose containers
  become: true
  community.docker.docker_container:
    container: "{{ item.Id }}"
    state: absent
    force_kill: true
    remove_volumes: "{{ ovos_containers_docker_compose_remove_volumes }}"
  loop: "{{ ovos_containers_uninstall_container_ids | default([]) }}"
  when: ovos_containers_uninstall_container_ids | default([]) | length > 0

- name: List containers by name prefix
  become: true
  community.docker.docker_container_info:
    filters:
      name: "{{ item }}"
  loop: "{{ ovos_containers_uninstall_name_prefixes }}"
  register: ovos_containers_uninstall_name_info
  failed_when: false

- name: Flatten name prefix container list
  ansible.builtin.set_fact:
    ovos_containers_uninstall_name_ids: >-
      {{ ovos_containers_uninstall_name_info.results
         | selectattr('containers', 'defined')
         | map(attribute='containers')
         | sum(start=[]) }}
  when: ovos_containers_uninstall_name_info is defined

- name: Remove containers by name prefix
  become: true
  community.docker.docker_container:
    container: "{{ item.Id }}"
    state: absent
    force_kill: true
    remove_volumes: "{{ ovos_containers_docker_compose_remove_volumes }}"
  loop: "{{ ovos_containers_uninstall_name_ids | default([]) }}"
  when: ovos_containers_uninstall_name_ids | default([]) | length > 0

- name: Remove directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ ovos_containers_remove_directories }}"

- name: Delete composer directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ ovos_containers_repo_directories }}"
