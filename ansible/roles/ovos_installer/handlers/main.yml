---
- name: Start Sound Server
  ansible.builtin.include_tasks: block-sound.yml

- name: Restart OVOS services (user)
  listen: Restart OVOS services
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.systemd_service:
    name: ovos.service
    scope: user
    state: restarted
  failed_when: false
  when:
    - ovos_installer_method == "virtualenv"
    - (ovos_installer_systemd_scope | default('user')) == 'user'

- name: Restart OVOS services (system)
  listen: Restart OVOS services
  ansible.builtin.systemd_service:
    name: ovos.service
    scope: system
    state: restarted
  failed_when: false
  when:
    - ovos_installer_method == "virtualenv"
    - (ovos_installer_systemd_scope | default('user')) == 'system'

- name: Restart WirePlumber
  listen: Restart OVOS services
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.systemd_service:
    name: wireplumber
    scope: user
    state: restarted
  failed_when: false
  when:
    - ovos_installer_method == "virtualenv"
    - ovos_installer_detect_sound_server is defined
    - ovos_installer_detect_sound_server.stdout == "pipewire"

- name: Reload Systemd User
  become: true
  become_user: "{{ ovos_installer_user }}"
  ansible.builtin.systemd_service:
    daemon_reload: true
    scope: user

- name: Reload Systemd
  ansible.builtin.systemd_service:
    daemon_reload: true

- name: Set Reboot
  ansible.builtin.set_fact:
    ovos_installer_reboot: true  # noqa var-naming

- name: Reload Udev rules
  listen: Reload Udev
  ansible.builtin.command: udevadm control --reload-rules
  changed_when: false

- name: Trigger Udev
  listen: Reload Udev
  ansible.builtin.command: udevadm trigger
  changed_when: false

- name: Restart NetworkManager
  ansible.builtin.systemd_service:
    name: NetworkManager
    state: restarted
  when:
    - ovos_installer_networkmanager_dir is defined
    - ovos_installer_networkmanager_dir.stat is defined
    - ovos_installer_networkmanager_dir.stat.exists | default(false) | bool
