---
- name: Block timezone
  block:
    - name: Auto-detect timezone
      ansible.builtin.uri:
        url: http://ip-api.com/json
        method: GET
        status_code:
          - 200
        return_content: true
        headers:
          Content-Type: application/json
      register: ovos_installer_detected_timezone
      until: ovos_installer_detected_timezone.status == 200
      retries: 5
      delay: 3

    - name: Set system's timezone
      community.general.timezone:
        name: "{{ ovos_installer_detected_timezone.json.timezone }}"

    - name: Set _ovos_installer_timezone fact
      ansible.builtin.set_fact:
        _ovos_installer_timezone: "{{ ovos_installer_detected_timezone.json.timezone }}"
  rescue:
    - name: Rescue timezone
      ansible.builtin.debug:
        msg: "The installer was not able to set the timezone..."

    - name: Read system timezone (rescue)
      ansible.builtin.command: timedatectl show -p Timezone --value
      register: ovos_installer_system_timezone
      changed_when: false
      failed_when: false

    - name: Set _ovos_installer_timezone fact from system timezone (rescue)
      ansible.builtin.set_fact:
        _ovos_installer_timezone: >-
          {{ (ovos_installer_system_timezone.stdout | default('') | trim) | default('UTC', true) }}
