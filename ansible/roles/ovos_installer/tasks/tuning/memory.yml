---
- name: Define systemd drop-in paths
  ansible.builtin.set_fact:
    ovos_installer_systemd_dropin_path: >-
      {{ '/etc/systemd/system' if (ovos_installer_systemd_scope | default('user')) == 'system'
         else ovos_installer_user_home + '/.config/systemd/user' }}
    ovos_installer_systemd_dropin_owner: "{{ 'root' if (ovos_installer_systemd_scope | default('user')) == 'system' else ovos_installer_user }}"
    ovos_installer_systemd_dropin_group: "{{ 'root' if (ovos_installer_systemd_scope | default('user')) == 'system' else ovos_installer_group }}"
    ovos_installer_systemd_dropin_user_path: "{{ ovos_installer_user_home }}/.config/systemd/user"
    ovos_installer_systemd_reload_handler: "{{ 'Reload Systemd' if (ovos_installer_systemd_scope | default('user')) == 'system' else 'Reload Systemd User' }}"

- name: Ensure OVOS systemd drop-in directories exist
  ansible.builtin.file:
    path: "{{ ovos_installer_systemd_dropin_path }}/{{ item }}.service.d"
    state: directory
    owner: "{{ ovos_installer_systemd_dropin_owner }}"
    group: "{{ ovos_installer_systemd_dropin_group }}"
    mode: '0755'
  loop:
    - ovos-core
    - ovos-audio
    - ovos-listener
    - ovos-messagebus
    - ovos-phal

- name: Ensure WirePlumber drop-in directory exists
  ansible.builtin.file:
    path: "{{ ovos_installer_systemd_dropin_user_path }}/wireplumber.service.d"
    state: directory
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: '0755'

- name: Apply Zero-Swap Policy to OVOS services
  ansible.builtin.copy:
    dest: "{{ ovos_installer_systemd_dropin_path }}/{{ item }}.service.d/99-noswap.conf"
    content: |
      [Service]
      # Prevent swapping of critical voice services
      MemorySwapMax=0
    owner: "{{ ovos_installer_systemd_dropin_owner }}"
    group: "{{ ovos_installer_systemd_dropin_group }}"
    mode: '0644'
  notify:
    - "{{ ovos_installer_systemd_reload_handler }}"
    - Restart OVOS services
  loop:
    - ovos-core
    - ovos-audio
    - ovos-listener
    - ovos-messagebus
    - ovos-phal

- name: Apply Zero-Swap Policy to WirePlumber
  ansible.builtin.copy:
    dest: "{{ ovos_installer_systemd_dropin_user_path }}/wireplumber.service.d/99-noswap.conf"
    content: |
      [Service]
      # Prevent swapping of critical voice services
      MemorySwapMax=0
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: '0644'
  notify:
    - Reload Systemd User
    - Restart OVOS services

- name: Calculate CPU affinity for latency-critical services
  vars:
    _vcpus: "{{ ansible_facts.processor_vcpus | default(ansible_facts.processor_count | default(1)) | int }}"
  ansible.builtin.set_fact:
    ovos_installer_rt_cpu_affinity: >-
      {{ ((_vcpus | int) >= 4) | ternary((range((_vcpus | int) // 2, (_vcpus | int)) | list) | join(' '), '') }}

- name: Apply RT scheduling and CPU affinity to OVOS services
  ansible.builtin.copy:
    dest: "{{ ovos_installer_systemd_dropin_path }}/{{ item }}.service.d/98-performance.conf"
    content: |
      [Service]
      AmbientCapabilities=CAP_SYS_NICE
      CapabilityBoundingSet=CAP_SYS_NICE
      CPUSchedulingPolicy=fifo
      CPUSchedulingPriority=70
      LimitRTPRIO=95
      LimitMEMLOCK=infinity
      {% if ovos_installer_rt_cpu_affinity | length > 0 %}
      CPUAffinity={{ ovos_installer_rt_cpu_affinity }}
      {% endif %}
    owner: "{{ ovos_installer_systemd_dropin_owner }}"
    group: "{{ ovos_installer_systemd_dropin_group }}"
    mode: '0644'
  when: (ovos_installer_systemd_scope | default('user')) == 'system'
  notify:
    - "{{ ovos_installer_systemd_reload_handler }}"
    - Restart OVOS services
  loop:
    - ovos-audio
    - ovos-listener
    - ovos-core

- name: Apply RT scheduling and CPU affinity to WirePlumber
  ansible.builtin.copy:
    dest: "{{ ovos_installer_systemd_dropin_user_path }}/wireplumber.service.d/98-performance.conf"
    content: |
      [Service]
      AmbientCapabilities=CAP_SYS_NICE
      CapabilityBoundingSet=CAP_SYS_NICE
      CPUSchedulingPolicy=fifo
      CPUSchedulingPriority=70
      LimitRTPRIO=95
      LimitMEMLOCK=infinity
      {% if ovos_installer_rt_cpu_affinity | length > 0 %}
      CPUAffinity={{ ovos_installer_rt_cpu_affinity }}
      {% endif %}
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: '0644'
  when: (ovos_installer_systemd_scope | default('user')) == 'system'
  notify:
    - Reload Systemd User
    - Restart OVOS services

- name: Block uninstall memory tuning
  when: ovos_installer_cleaning | bool
  tags:
    - uninstall
  block:
    - name: Remove Zero-Swap Policy drop-ins
      ansible.builtin.file:
        path: "{{ ovos_installer_systemd_dropin_path }}/{{ item }}.service.d/99-noswap.conf"
        state: absent
      notify:
        - "{{ ovos_installer_systemd_reload_handler }}"
      loop:
        - ovos-core
        - ovos-audio
        - ovos-listener
        - ovos-messagebus
        - ovos-phal

    - name: Remove WirePlumber Zero-Swap drop-in
      ansible.builtin.file:
        path: "{{ ovos_installer_systemd_dropin_user_path }}/wireplumber.service.d/99-noswap.conf"
        state: absent
      notify:
        - Reload Systemd User

    - name: Remove RT scheduling drop-ins
      ansible.builtin.file:
        path: "{{ ovos_installer_systemd_dropin_path }}/{{ item }}.service.d/98-performance.conf"
        state: absent
      notify:
        - "{{ ovos_installer_systemd_reload_handler }}"
      loop:
        - ovos-audio
        - ovos-listener
        - ovos-core

    - name: Remove WirePlumber RT scheduling drop-in
      ansible.builtin.file:
        path: "{{ ovos_installer_systemd_dropin_user_path }}/wireplumber.service.d/98-performance.conf"
        state: absent
      notify:
        - Reload Systemd User

    - name: Remove empty drop-in directories
      ansible.builtin.file:
        path: "{{ ovos_installer_systemd_dropin_path }}/{{ item }}.service.d"
        state: absent
      loop:
        - ovos-core
        - ovos-audio
        - ovos-listener
        - ovos-messagebus
        - ovos-phal

    - name: Remove WirePlumber drop-in directory
      ansible.builtin.file:
        path: "{{ ovos_installer_systemd_dropin_user_path }}/wireplumber.service.d"
        state: absent
