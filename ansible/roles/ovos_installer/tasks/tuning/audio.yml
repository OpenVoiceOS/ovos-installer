---
- name: Configure audio tuning
  when: not ovos_installer_cleaning | bool
  block:
    - name: Ensure user PipeWire config directory exists
      ansible.builtin.file:
        path: "{{ ovos_installer_user_home }}/.config/pipewire/pipewire.conf.d"
        state: directory
        owner: "{{ ovos_installer_user }}"
        group: "{{ ovos_installer_group }}"
        mode: '0755'

    - name: Configure PipeWire for Low Latency (User Scope)
      ansible.builtin.copy:
        dest: "{{ ovos_installer_user_home }}/.config/pipewire/pipewire.conf.d/99-low-latency.conf"
        content: |
          context.properties = {
              default.clock.rate = 48000
              default.clock.allowed-rates = [ 44100, 48000 ]
              default.clock.quantum = {{ 256 if ovos_installer_tuning_audio_low_latency | bool else 512 }}
              default.clock.min-quantum = {{ 128 if ovos_installer_tuning_audio_low_latency | bool else 256 }}
              default.clock.max-quantum = {{ 1024 if ovos_installer_tuning_audio_low_latency | bool else 2048 }}
          }
        owner: "{{ ovos_installer_user }}"
        group: "{{ ovos_installer_group }}"
        mode: '0644'
      notify: Start Sound Server

    - name: Ensure WirePlumber config directory exists
      ansible.builtin.file:
        path: "{{ ovos_installer_user_home }}/.config/wireplumber/wireplumber.conf.d"
        state: directory
        owner: "{{ ovos_installer_user }}"
        group: "{{ ovos_installer_group }}"
        mode: '0755'

    - name: Disable WirePlumber idle suspend for audio devices
      ansible.builtin.copy:
        dest: "{{ ovos_installer_user_home }}/.config/wireplumber/wireplumber.conf.d/99-disable-idle.conf"
        content: |
          monitor.alsa.rules = [
            {
              matches = [ { node.name = "~alsa_output.*" } ]
              actions = {
                update-props = {
                  session.suspend-timeout-seconds = 0
                  node.pause-on-idle = false
                  node.suspend-on-idle = false
                  node.always-process = true
                }
              }
            }
            {
              matches = [ { node.name = "~alsa_input.*" } ]
              actions = {
                update-props = {
                  session.suspend-timeout-seconds = 0
                  node.pause-on-idle = false
                  node.suspend-on-idle = false
                  node.always-process = true
                  node.latency = {{ '256/48000' if ovos_installer_tuning_audio_low_latency | bool else '512/48000' }}
                }
              }
            }
          ]
        owner: "{{ ovos_installer_user }}"
        group: "{{ ovos_installer_group }}"
        mode: '0644'
      notify: Restart OVOS services

    - name: Bump PipeWire default source volume
      become: true
      become_user: "{{ ovos_installer_user }}"
      ansible.builtin.command:
        argv:
          - wpctl
          - set-volume
          - "@DEFAULT_AUDIO_SOURCE@"
          - "{{ ovos_installer_tuning_source_volume }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ ovos_installer_uid }}"
        DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ ovos_installer_uid }}/bus"
      changed_when: false
      failed_when: false
      when:
        - ovos_installer_detect_sound_server is defined
        - ovos_installer_detect_sound_server.stdout == "pipewire"

    - name: Install rtkit for real-time audio scheduling
      ansible.builtin.package:
        name: rtkit
        state: present
      register: ovos_installer_rtkit_install_result
      ignore_errors: true

    - name: Remove system-wide PipeWire tuning (Cleanup)
      ansible.builtin.file:
        path: /etc/pipewire/pipewire.conf.d/99-low-latency.conf
        state: absent

    - name: Configure USB Audio Driver for Low Latency
      ansible.builtin.copy:
        dest: /etc/modprobe.d/snd-usb-audio.conf
        content: |
          # Force USB scheduler to process packets ASAP (Default is 8)
          options snd-usb-audio nrpacks=1
        owner: root
        group: root
        mode: '0644'
      notify: Set Reboot

- name: Block uninstall usb audio tuning
  when: ovos_installer_cleaning | bool
  tags:
    - uninstall
  block:
    - name: Remove user PipeWire low-latency config
      ansible.builtin.file:
        path: "{{ ovos_installer_user_home }}/.config/pipewire/pipewire.conf.d/99-low-latency.conf"
        state: absent

    - name: Remove WirePlumber idle suspend override
      ansible.builtin.file:
        path: "{{ ovos_installer_user_home }}/.config/wireplumber/wireplumber.conf.d/99-disable-idle.conf"
        state: absent

    - name: Remove rtkit package
      ansible.builtin.package:
        name: rtkit
        state: absent
      failed_when: false

    - name: Remove USB Audio configuration
      ansible.builtin.file:
        path: /etc/modprobe.d/snd-usb-audio.conf
        state: absent
