---
- name: Detect available TCP congestion control algorithms
  ansible.builtin.command: sysctl -n net.ipv4.tcp_available_congestion_control
  register: ovos_installer_tcp_cc
  changed_when: false
  failed_when: false

- name: Check for kernel.nmi_watchdog sysctl
  ansible.builtin.stat:
    path: /proc/sys/kernel/nmi_watchdog
  register: ovos_installer_nmi_watchdog_sysctl
  changed_when: false
  failed_when: false
  tags:
    - always

- name: Remove kernel.nmi_watchdog sysctl when unsupported
  ansible.posix.sysctl:
    name: kernel.nmi_watchdog
    state: absent
    sysctl_file: /etc/sysctl.d/99-ovos.conf
    reload: false
  when:
    - not ovos_installer_nmi_watchdog_sysctl.stat.exists | default(false) | bool
  tags:
    - always

- name: Handle sysctl tuning for Open Voice OS
  ansible.posix.sysctl:
    name: "{{ item.option }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-ovos.conf
    reload: false
    state: "{{ ovos_installer_uninstall }}"
  loop:
    - { "option": "net.ipv4.tcp_slow_start_after_idle", "value": 0 }
    - { "option": "net.ipv4.tcp_tw_reuse", "value": 1 }
    - { "option": "net.core.netdev_max_backlog", "value": 50000 }
    - { "option": "net.ipv4.tcp_max_syn_backlog", "value": 30000 }
    - { "option": "net.ipv4.tcp_max_tw_buckets", "value": 2000000 }
    - { "option": "net.core.rmem_max", "value": 16777216 }
    - { "option": "net.core.wmem_max", "value": 16777216 }
    - { "option": "net.core.rmem_default", "value": 16777216 }
    - { "option": "net.core.wmem_default", "value": 16777216 }
    - { "option": "net.ipv4.tcp_rmem", "value": "4096 87380 16777216" }
    - { "option": "net.ipv4.tcp_wmem", "value": "4096 65536 16777216" }
    - { "option": "net.core.optmem_max", "value": 40960 }
    - { "option": "fs.inotify.max_user_instances", "value": 8192 }
    - { "option": "fs.inotify.max_user_watches", "value": 524288 }

    # Ultra Snappy Tuning
    - { "option": "net.ipv4.tcp_fastopen", "value": 3 } # Enable TCP Fast Open (client/server)
    - { "option": "kernel.sched_rt_runtime_us", "value": 980000 } # Increase RT runtime limit (default 950000)
    - { "option": "net.core.default_qdisc", "value": "fq" } # Required for BBR
    - { "option": "vm.min_free_kbytes", "value": 65536 } # Safety reserve to prevent network stalls (64MB)
    - { "option": "kernel.sched_autogroup_enabled", "value": 0 } # Improve service latency vs interactive shells
    # Advanced I/O Latency Tuning
    - { "option": "kernel.nmi_watchdog", "value": 0 } # Disable NMI watchdog (stops periodic CPU interrupts)
    - { "option": "vm.dirty_background_ratio", "value": 5 } # Write to disk early (avoid bufferbloat)
    - { "option": "vm.dirty_ratio", "value": 10 } # Throttle early to prevent massive system freezes
  when: item.option != 'kernel.nmi_watchdog' or ovos_installer_nmi_watchdog_sysctl.stat.exists | default(false) | bool
  tags:
    - always

- name: Enable BBR congestion control when available
  ansible.posix.sysctl:
    name: net.ipv4.tcp_congestion_control
    value: bbr
    sysctl_file: /etc/sysctl.d/99-ovos.conf
    reload: false
    state: "{{ ovos_installer_uninstall }}"
  when:
    - "'bbr' in (ovos_installer_tcp_cc.stdout | default(''))"
  tags:
    - always

- name: Reload sysctl tuning
  ansible.builtin.command: sysctl -p /etc/sysctl.d/99-ovos.conf
  register: ovos_installer_sysctl_reload
  changed_when: ovos_installer_sysctl_reload.rc == 0
  when: not ovos_installer_cleaning | bool
  tags:
    - always

- name: Disable Transparent Hugepages (THP) - Persistent
  ansible.builtin.copy:
    dest: /etc/tmpfiles.d/thp.conf
    content: |
      w /sys/kernel/mm/transparent_hugepage/enabled - - - - never
    owner: root
    group: root
    mode: "0644"
  notify: Reload Systemd

- name: Remove 99-ovos.conf file
  ansible.builtin.file:
    path: /etc/sysctl.d/99-ovos.conf
    state: absent
  when: ovos_installer_cleaning | bool
  tags:
    - uninstall

- name: Remove THP tmpfiles configuration
  ansible.builtin.file:
    path: /etc/tmpfiles.d/thp.conf
    state: absent
  when: ovos_installer_cleaning | bool
  notify: Reload Systemd
  tags:
    - uninstall
