---
- name: Configure NetworkManager DNS caching
  when:
    - ovos_installer_networkmanager_dir.stat.exists | default(false) | bool
    - not ovos_installer_cleaning | bool
  block:
    - name: Install dnsmasq for NetworkManager caching
      ansible.builtin.package:
        name: dnsmasq
        state: present

    - name: Stop system dnsmasq to avoid port conflicts
      ansible.builtin.systemd_service:
        name: dnsmasq
        state: stopped
        enabled: false
      failed_when: false
      notify: Restart NetworkManager

    - name: Enable NetworkManager dnsmasq caching
      ansible.builtin.copy:
        dest: /etc/NetworkManager/conf.d/90-dnsmasq.conf
        content: |
          [main]
          dns=dnsmasq
        owner: root
        group: root
        mode: "0644"
      notify: Restart NetworkManager

    - name: Ensure NetworkManager dnsmasq config directory exists
      ansible.builtin.file:
        path: /etc/NetworkManager/dnsmasq.d
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Configure dnsmasq cache TTLs
      ansible.builtin.copy:
        dest: /etc/NetworkManager/dnsmasq.d/ovos.conf
        content: |
          cache-size=1000
          min-cache-ttl=60
          max-cache-ttl=3600
        owner: root
        group: root
        mode: "0644"
      notify: Restart NetworkManager

- name: Block uninstall DNS caching
  when: ovos_installer_cleaning | bool
  tags:
    - uninstall
  block:
    - name: Remove NetworkManager dnsmasq config
      ansible.builtin.file:
        path: /etc/NetworkManager/conf.d/90-dnsmasq.conf
        state: absent
      when: ovos_installer_networkmanager_dir.stat.exists | default(false) | bool
      notify: Restart NetworkManager

    - name: Remove dnsmasq cache config
      ansible.builtin.file:
        path: /etc/NetworkManager/dnsmasq.d/ovos.conf
        state: absent
      when: ovos_installer_networkmanager_dir.stat.exists | default(false) | bool
      notify: Restart NetworkManager
