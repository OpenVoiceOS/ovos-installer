---
- name: Define directories to backup before uninstall
  ansible.builtin.set_fact:
    ovos_installer_directories_backup:
      - "{{ ovos_installer_user_home }}/ovos/*"
      - "{{ ovos_installer_user_home }}/hivemind/*"
      - "{{ ovos_installer_user_home }}/.config/systemd/user/*"
      - "{{ ovos_installer_user_home }}/.config/mycroft/*"
      - "{{ ovos_installer_user_home }}/.config/hivemind/*"
      - "{{ ovos_installer_user_home }}/.config/OpenVoiceOS/*"
      - "{{ ovos_installer_user_home }}/.config/ovos_persona/*"
      - "{{ ovos_installer_user_home }}/.config/wireplumber/*"
      - "{{ ovos_installer_user_home }}/.config/pipewire/*"
      - "{{ ovos_installer_user_home }}/.local/share/hivemind/*"
      - "{{ ovos_installer_user_home }}/.local/state/ovos/*"
      - "{{ ovos_installer_user_home }}/.local/state/mycroft/*"
  when: ovos_installer_cleaning | bool
  tags:
    - uninstall

- name: Check if directories to backup exist
  ansible.builtin.stat:
    path: "{{ item }}"
  loop: "{{ ovos_installer_directories_backup }}"
  register: ovos_installer_directory_exists
  when: ovos_installer_cleaning | bool
  tags:
    - uninstall

- name: Backup existing configurations before uninstall
  community.general.archive:
    path: "{{ ovos_installer_directories_backup }}"
    dest: "{{ ovos_installer_user_home }}/ovos-backup.tar.gz"
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: "0755"
    format: gz
    force_archive: true
  when:
    - ovos_installer_cleaning | bool
    - ovos_installer_directory_exists.results
      | selectattr('stat.exists')
      | list
      | length
      | int > 0
  tags:
    - uninstall

- name: Remove installer logs on uninstall
  ansible.builtin.file:
    path: /var/log/ovos-installer.log
    state: absent
  when: ovos_installer_cleaning | bool
  tags:
    - uninstall

- name: Create container directories
  ansible.builtin.file:
    path: "{{ item.directory }}"
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: "0755"
    state: directory
  loop:
    - directory: "{{ ovos_installer_user_home }}/.config/systemd/user"
      status: true
    - directory: "{{ ovos_installer_user_home }}/ovos"
      status: true
    - directory: "{{ ovos_installer_user_home }}/ovos/config"
      status: true
    - directory: "{{ ovos_installer_user_home }}/ovos/config/persona"
      status: true
    - directory: "{{ ovos_installer_user_home }}/ovos/config/phal"
      status: true
    - directory: "{{ ovos_installer_user_home }}/ovos/share"
      status: true
    - directory: "{{ ovos_installer_user_home }}/ovos/tmp"
      status: true
    - directory: "{{ ovos_installer_user_home }}/hivemind"
      status: "{{ ovos_installer_profile != 'ovos' }}"
    - directory: "{{ ovos_installer_user_home }}/hivemind/config"
      status: "{{ ovos_installer_profile != 'ovos' }}"
    - directory: "{{ ovos_installer_user_home }}/hivemind/share"
      status: "{{ ovos_installer_profile != 'ovos' }}"
  when:
    - item.status | bool
    - ovos_installer_method == "containers"

- name: Create virtualenv directories
  ansible.builtin.file:
    path: "{{ item.directory }}"
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: "0755"
    state: directory
  loop:
    - directory: "{{ ovos_installer_user_home }}/.config/mycroft"
      status: true
    - directory: "{{ ovos_installer_user_home }}/.config/ovos_persona"
      status: true
    - directory: "{{ ovos_installer_user_home }}/.local"
      status: true
    - directory: "{{ ovos_installer_user_home }}/.local/bin"
      status: true
    - directory: "{{ ovos_installer_user_home }}/.config/hivemind"
      status: "{{ ovos_installer_profile != 'ovos' }}"
    - directory: "{{ ovos_installer_user_home }}/.config/systemd/user"
      status: true
    - directory: "{{ ovos_installer_user_home }}/nltk_data"
      status: true
  when:
    - item.status | bool
    - ovos_installer_method == "virtualenv"

- name: Resolve locale units based on public IP
  when:
    - ovos_installer_profile != "server"
    - ovos_installer_geoip_enabled | bool
  block:
    - name: Fetch geoip metadata
      ansible.builtin.uri:
        url: "{{ ovos_installer_geoip_url }}"
        return_content: true
        timeout: 5
      register: ovos_installer_geoip_response
      failed_when: false
      changed_when: false

    - name: Set geoip country code
      ansible.builtin.set_fact:
        ovos_installer_geoip_country: >-
          {{
            (ovos_installer_geoip_response.json.country_code
             | default(ovos_installer_geoip_response.json.country | default(''))) | upper
          }}
      when: ovos_installer_geoip_response.json is defined

    - name: Apply imperial unit defaults for select countries
      ansible.builtin.set_fact:
        ovos_installer_system_unit: "imperial"
        ovos_installer_temperature_unit: "fahrenheit"
        ovos_installer_precipitation_unit: "inch"
        ovos_installer_windspeed_unit: "mph"
      vars:
        _imperial_countries:
          - US
          - LR
          - MM
      when: ovos_installer_geoip_country | default('') in _imperial_countries

    - name: Apply date format defaults (MDY)
      ansible.builtin.set_fact:
        ovos_installer_date_format: "MDY"
      vars:
        _mdy_countries:
          - US
      when: ovos_installer_geoip_country | default('') in _mdy_countries

    - name: Apply date format defaults (YMD)
      ansible.builtin.set_fact:
        ovos_installer_date_format: "YMD"
      vars:
        _ymd_countries:
          - CN
          - JP
          - KR
          - TW
      when: ovos_installer_geoip_country | default('') in _ymd_countries

    - name: Apply time format defaults for 12-hour regions
      ansible.builtin.set_fact:
        ovos_installer_time_format: "half"
        ovos_installer_spoken_time_format: "half"
      vars:
        _half_time_countries:
          - US
          - CA
          - AU
          - NZ
          - PH
          - IN
          - IE
          - MY
          - PK
          - SA
          - ZA
          - EG
          - CO
          - GB
      when: ovos_installer_geoip_country | default('') in _half_time_countries

- name: Generate mycroft.conf
  vars:
    _configuration_path: "{{ '.config/mycroft' if ovos_installer_method == 'virtualenv' else 'ovos/config' }}"
  ansible.builtin.template:
    src: mycroft.conf.j2
    dest: "{{ ovos_installer_user_home }}/{{ _configuration_path }}/mycroft.conf"
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: "0600"
    backup: true
  register: ovos_installer_configuration
