---
- name: Add installer user to video and render groups
  ansible.builtin.user:
    name: "{{ ovos_installer_user }}"
    groups: audio
    append: true
  loop:
    - video
    - render

- name: EGLFS requirements when running on Raspberry Pi 5
  vars:
    _configuration_path: "{{ '.config' if ovos_installer_method == 'virtualenv' else 'ovos/config' }}"
  ansible.builtin.copy:
    content: |
      {
        "device": "/dev/dri/card1",
        "hwcursor": false
      }
    dest: "{{ ovos_installer_user_home }}/{{ _configuration_path }}/ovos-eglfs.json"
    owner: "{{ ovos_installer_user }}"
    group: "{{ ovos_installer_group }}"
    mode: "0600"
  when: "'Raspberry Pi 5' in ovos_installer_raspberrypi and ovos_installer_display_server == 'N/A'"

- name: Block DISPLAY server & Wayland socket
  when: ovos_installer_display_server != "N/A"
  block:
    - name: Check for wayland socket
      ansible.builtin.find:
        paths: "/run/user/{{ ovos_installer_uid }}"
        patterns: "wayland-[0-9]"
        file_type: any
      register: ovos_installer_ovos_wayland_display
      changed_when: false
      failed_when: false
      when: ovos_installer_display_server == 'wayland'

    - name: Set ovos_installer_wayland_display fact
      ansible.builtin.set_fact:
        ovos_installer_wayland_display: >-
          {{ (ovos_installer_ovos_wayland_display.files | map(attribute='path') | map('basename') | list | sort)[0] | default('') }}
      when:
        - ovos_installer_ovos_wayland_display is defined
        - ovos_installer_display_server == 'wayland'

    - name: Detect DISPLAY server number
      ansible.builtin.command:
        argv:
          - python3
          - -c
          - |
            import collections
            import glob
            import os
            import re

            display_re = re.compile(r'^DISPLAY=(:[0-9](?:\.[0-9]+)?)$')
            counts = collections.Counter()

            for path in glob.glob('/proc/[0-9]*/environ'):
                try:
                    with open(path, 'rb') as fh:
                        for item in fh.read().split(b'\0'):
                            if item.startswith(b'DISPLAY='):
                                m = display_re.match(item.decode('utf-8', 'ignore'))
                                if m:
                                    counts[m.group(1)] += 1
                except Exception:
                    continue

            if counts:
                print(counts.most_common(1)[0][0])
            else:
                xdir = '/tmp/.X11-unix'
                if os.path.isdir(xdir):
                    candidates = []
                    for name in os.listdir(xdir):
                        m = re.match(r'^X([0-9]+)$', name)
                        if m:
                            candidates.append(int(m.group(1)))
                    if candidates:
                        print(f':{sorted(candidates)[0]}')
      register: ovos_installer_ovos_display_server_number
      changed_when: false

    - name: Set ovos_installer_display_server_number fact
      ansible.builtin.set_fact:
        ovos_installer_display_server_number: "{{ ovos_installer_ovos_display_server_number.stdout }}"
      when: ovos_installer_ovos_display_server_number.stdout | length > 0
