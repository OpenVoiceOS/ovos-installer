---
- name: Assert uninstall mode
  ansible.builtin.assert:
    that:
      - ovos_installer_cleaning | default(false) | bool
    fail_msg: "Uninstall tasks require ovos_installer_cleaning=true."
  tags:
    - uninstall

- name: Disable and unload OVOS launchd user services
  vars:
    ovos_services_launchd_plist_name: "{{ item.label }}.plist"
  become: true
  become_user: "{{ ovos_services_launchd_user_module_become_user }}"
  community.general.launchd:
    name: "{{ item.label }}"
    plist: "{{ ovos_services_launchd_plist_name }}"
    enabled: false
    state: unloaded
  environment: "{{ ovos_services_launchd_user_module_environment }}"
  failed_when: false
  loop: "{{ ovos_services_launchd_unit_definitions }}"
  loop_control:
    label: "{{ item.label }} ({{ item.scope }})"
  when: item.scope == 'user'

- name: Check legacy OVOS core launchd plist files
  ansible.builtin.stat:
    path: "{{ ovos_services_launchd_agents_path }}/{{ item }}.plist"
  register: ovos_services_legacy_core_plists
  changed_when: false
  loop: "{{ ovos_services_launchd_legacy_core_labels }}"
  loop_control:
    label: "{{ item }}"
  when: item != ovos_services_launchd_core_label

- name: Disable and unload legacy OVOS core launchd services
  vars:
    # community.general.launchd resolves plist names in the expected launchd
    # directories; keep basename form for compatibility.
    ovos_services_launchd_plist_name: "{{ item.item }}.plist"
  become: true
  become_user: "{{ ovos_services_launchd_user_module_become_user }}"
  community.general.launchd:
    name: "{{ item.item }}"
    plist: "{{ ovos_services_launchd_plist_name }}"
    enabled: false
    state: unloaded
  environment: "{{ ovos_services_launchd_user_module_environment }}"
  failed_when: false
  loop: "{{ ovos_services_legacy_core_plists.results | default([]) }}"
  loop_control:
    label: "{{ item.item }}"
  when:
    - item.item != ovos_services_launchd_core_label
    - item.stat.exists | default(false)

- name: Disable and unload OVOS launchd system services
  vars:
    ovos_services_launchd_plist_name: "{{ item.label }}.plist"
  become: true
  community.general.launchd:
    name: "{{ item.label }}"
    plist: "{{ ovos_services_launchd_plist_name }}"
    enabled: false
    state: unloaded
  failed_when: false
  loop: "{{ ovos_services_launchd_unit_definitions }}"
  loop_control:
    label: "{{ item.label }} ({{ item.scope }})"
  when: item.scope == 'system'

- name: Remove OVOS launchd plist files
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ ovos_services_launchd_unit_files_system + ovos_services_launchd_unit_files_user }}"

- name: Remove legacy OVOS core launchd plist files
  become: true
  ansible.builtin.file:
    path: "{{ ovos_services_launchd_agents_path }}/{{ item }}.plist"
    state: absent
  loop: "{{ ovos_services_launchd_legacy_core_labels }}"
  loop_control:
    label: "{{ item }}"
  when: item != ovos_services_launchd_core_label

- name: Check launchd shell init file
  ansible.builtin.stat:
    path: "{{ ovos_services_launchd_shell_init_file }}"
  register: ovos_services_launchd_shell_init
  changed_when: false

- name: Remove OVOS launchd wrapper source block from shell init file
  ansible.builtin.blockinfile:
    path: "{{ ovos_services_launchd_shell_init_file }}"
    marker: "# {mark} {{ ovos_services_launchd_shell_marker }}"
    block: |
      if [ -f "{{ ovos_services_launchd_wrapper_path }}" ]; then
        source "{{ ovos_services_launchd_wrapper_path }}"
      fi
    state: absent
  when: ovos_services_launchd_shell_init.stat.exists | default(false) | bool

- name: Remove OVOS launchd shell wrapper
  ansible.builtin.file:
    path: "{{ ovos_services_launchd_wrapper_path }}"
    state: absent

- name: Remove wrapper script
  become: true
  ansible.builtin.file:
    path: "{{ ovos_services_wrapper_path }}"
    state: absent

- name: Remove directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ ovos_services_remove_directories }}"
